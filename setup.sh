#!/bin/bash
# ==============================================
#  Llama 3.1 8B Instruct â€” Setup Script
#  ì‹¤í–‰: bash setup.sh
# ==============================================

set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

echo "======================================"
echo "  ğŸ¦™ Llama 3.1 8B Instruct Setup"
echo "======================================"

# ----------------------------------------------
# 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜
# ----------------------------------------------
echo ""
echo "[1/3] íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
pip install -r requirements.txt
echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

# ----------------------------------------------
# 2. Hugging Face ë¡œê·¸ì¸ í™•ì¸
# ----------------------------------------------
echo ""
echo "[2/3] Hugging Face ì¸ì¦ í™•ì¸ ì¤‘..."

if [ -z "$HF_TOKEN" ]; then
    echo "âš ï¸  HF_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    echo "   ì›Œí¬ë¡œë“œ í™˜ê²½ë³€ìˆ˜ì— HF_TOKENì„ ì„¤ì •í•˜ê±°ë‚˜"
    echo "   ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì§ì ‘ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”:"
    echo ""
    echo "   huggingface-cli login"
    echo ""
    read -p "   ì§ì ‘ ë¡œê·¸ì¸ í›„ Enterë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”..."
else
    huggingface-cli login --token "$HF_TOKEN"
    echo "âœ… Hugging Face ì¸ì¦ ì™„ë£Œ"
fi

# ----------------------------------------------
# 3. ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
# ----------------------------------------------
echo ""
echo "[3/3] ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘... (ì•½ 16GB, ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤)"

MODEL_DIR="/workspace/models/llama-3.1-8b-instruct"
mkdir -p "$MODEL_DIR"

huggingface-cli download meta-llama/Meta-Llama-3.1-8B-Instruct \
    --local-dir "$MODEL_DIR" \
    --exclude "original/*"

echo "âœ… ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: $MODEL_DIR"

# ----------------------------------------------
# ì™„ë£Œ
# ----------------------------------------------
echo ""
echo "======================================"
echo "  âœ… Setup ì™„ë£Œ!"
echo "  ì´ì œ ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ì„¸ìš”:"
echo ""
echo "  python run.py"
echo "======================================"